<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Excelå¯¼å…¥å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft YaHei", "PingFang SC", -apple-system,
          BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        padding: 0;
        color: #333;
        overflow: hidden;
      }

      .app-container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: visible;
        height: 100vh;
      }

      .header {
        background: linear-gradient(90deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        font-weight: 300;
        margin-bottom: 5px;
      }

      .header p {
        font-size: 14px;
        opacity: 0.9;
      }

      .main-content {
        display: flex;
        height: calc(100vh - 120px);
      }

      .left-panel {
        flex: 1;
        padding: 25px;
        border-right: 1px solid #e1e5e9;
        background: #fafbfc;
        display: flex;
        flex-direction: column;
        min-width: 400px;
        min-height: 700px;
      }

      .right-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
        min-width: 400px;
        min-height: 700px;
      }

      .config-section {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .logs-section {
        flex: 1;
        padding: 25px;
        display: flex;
        flex-direction: column;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
      }

      .section-title::before {
        content: "";
        width: 4px;
        height: 18px;
        background: #667eea;
        margin-right: 10px;
        border-radius: 2px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
        flex: 1;
        align-items: start;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #555;
        margin-bottom: 6px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e1e5e9;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
        font-family: inherit;
        box-sizing: border-box;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      /* Checkbox ç‰¹æ®Šæ ·å¼ */
      input[type="checkbox"] {
        width: auto;
        min-width: 18px;
        height: 18px;
        padding: 0;
        margin: 0;
        margin-right: 8px;
        cursor: pointer;
        -webkit-appearance: checkbox;
        -moz-appearance: checkbox;
        appearance: checkbox;
        border: 2px solid #667eea;
        border-radius: 4px;
        flex-shrink: 0;
      }

      input[type="checkbox"]:checked {
        background-color: #667eea;
        border-color: #667eea;
      }

      input[type="checkbox"]:focus {
        outline: 2px solid rgba(102, 126, 234, 0.3);
        outline-offset: 2px;
      }

      select {
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        padding-right: 40px;
        cursor: pointer;
      }

      /* ç¡®ä¿æ‰€æœ‰è¡¨å•æ§ä»¶é«˜åº¦ä¸€è‡´ */
      input,
      select {
        height: 44px;
        line-height: 1.2;
        display: block;
      }

      /* ç‰¹æ®Šå¤„ç†textarea */
      textarea {
        height: auto;
        line-height: 1.4;
        display: block;
      }

      /* ç»Ÿä¸€è¾“å…¥æ¡†çš„å‚ç›´å¯¹é½ */
      .form-group {
        position: relative;
      }

      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #555;
        font-size: 13px;
      }

      textarea {
        resize: vertical;
        min-height: 60px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .file-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }

      .file-input-display {
        flex: 1;
        padding: 10px 12px;
        border: 2px dashed #d1d5db;
        border-radius: 6px;
        background: #f9fafb;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        overflow: hidden; /* å¿…é¡»ï¼šé˜²æ­¢æº¢å‡º */
        white-space: nowrap;
        min-width: 0; /* å¿…é¡»ï¼šå…è®¸ flex é¡¹ç›®æ”¶ç¼© */
      }

      .file-input-display:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .file-input-display::before {
        content: "ğŸ“";
        margin-right: 8px;
      }

      .file-name {
        margin-left: 8px;
        color: #333;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        direction: rtl; /* è·¯å¾„è¿‡é•¿æ—¶ï¼Œä¿ç•™å³ä¾§æ–‡ä»¶åï¼Œçœç•¥å·¦ä¾§è·¯å¾„ */
        text-align: left;
        white-space: nowrap;
        flex: 1;
      }

      .button-group {
        display: flex;
        gap: 12px;
        margin-top: 20px;
      }

      button {
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
      }

      .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .logs-container {
        flex: 1;
        background: #1f2937;
        border-radius: 6px;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 400px;
      }

      .logs-header {
        padding: 12px 16px;
        background: #374151;
        color: #e5e7eb;
        font-size: 13px;
        font-weight: 600;
        border-bottom: 1px solid #4b5563;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
      }

      .connection-status.ready {
        color: #10b981;
      }

      .connection-status.connecting {
        color: #f59e0b;
      }

      .connection-status.error {
        color: #ef4444;
      }

      .logs-content {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 12px;
        line-height: 1.5;
        color: #e5e7eb;
      }

      /* æ¨¡æ€å¯¹è¯æ¡†æ ·å¼ */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      }

      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow: hidden;
        animation: slideIn 0.3s ease;
      }

      .modal-header {
        padding: 20px 24px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
      }

      .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .modal-body {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .comparison-modal-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .log-entry {
        margin-bottom: 4px;
        padding: 2px 0;
      }

      .log-info {
        color: #3b82f6;
      }

      .log-success {
        color: #10b981;
      }

      .log-error {
        color: #ef4444;
      }

      .log-warning {
        color: #f59e0b;
      }

      .progress-container {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #667eea;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #3b82f6);
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 4px;
      }

      .progress-text {
        font-size: 12px;
        color: #6b7280;
        text-align: center;
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-ready {
        background: #10b981;
      }

      .status-busy {
        background: #f59e0b;
        animation: pulse 2s infinite;
      }

      .status-error {
        background: #ef4444;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* å­—æ®µå¯¹æ¯”æ ·å¼ */
      .comparison-section {
        padding: 25px;
        border-bottom: 1px solid #e1e5e9;
        flex-shrink: 0;
      }

      .comparison-container {
        background: white;
        border-radius: 8px;
        border: 1px solid #e1e5e9;
        overflow: hidden;
      }

      .comparison-header {
        padding: 16px;
        background: #f8f9fa;
        border-bottom: 1px solid #e1e5e9;
      }

      .comparison-summary {
        font-size: 14px;
        color: #374151;
        line-height: 1.5;
      }

      .comparison-summary .match-count {
        color: #10b981;
        font-weight: 600;
      }

      .comparison-summary .mismatch-count {
        color: #f59e0b;
        font-weight: 600;
      }

      .comparison-content {
        padding: 16px;
      }

      .field-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .field-list h4 {
        margin: 0 0 12px 0;
        color: #374151;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
      }

      .field-list h4::before {
        margin-right: 8px;
      }

      .field-items {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .field-item {
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        display: flex;
        align-items: center;
      }

      .field-item::before {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
        flex-shrink: 0;
      }

      .field-matched {
        background: #d1fae5;
        border-color: #10b981;
        color: #065f46;
      }

      .field-matched::before {
        background: #10b981;
      }

      .field-missing {
        background: #fef3c7;
        border-color: #f59e0b;
        color: #92400e;
      }

      .field-missing::before {
        background: #f59e0b;
      }

      .field-extra {
        background: #fee2e2;
        border-color: #ef4444;
        color: #991b1b;
      }

      .field-extra::before {
        background: #ef4444;
      }

      .field-normal {
        background: #f3f4f6;
        color: #374151;
      }

      .field-normal::before {
        background: #9ca3af;
      }

      .logs-section {
        flex: 1;
        padding: 25px;
        display: flex;
        flex-direction: column;
        min-height: 300px;
      }

      @media (max-width: 900px) {
        .main-content {
          flex-direction: column;
          height: auto;
        }

        .left-panel,
        .right-panel {
          border-right: none;
          border-bottom: 1px solid #e1e5e9;
          min-width: unset;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }

        .app-container {
          height: 100vh;
        }

        .main-content {
          height: calc(100vh - 120px);
        }

        .field-comparison {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .comparison-section {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="header">
        <h1>ğŸ“Š Excelå¯¼å…¥å·¥å…·</h1>
        <p>é«˜æ•ˆã€å®‰å…¨åœ°å°†Excel/CSVæ•°æ®å¯¼å…¥åˆ°æ•°æ®åº“ä¸­</p>
      </div>

      <div class="main-content">
        <div class="left-panel">
          <div class="config-section">
            <div class="section-title">ğŸ“‹ é…ç½®å‚æ•°</div>

            <div class="form-grid">
              <div class="form-group">
                <label for="dbType">æ•°æ®åº“ç±»å‹</label>
                <select id="dbType" onchange="onDbTypeChange()">
                  <option value="mysql">MySQL</option>
                  <option value="oracle">Oracle</option>
                </select>
              </div>

              <div class="form-group">
                <label for="host">ä¸»æœºåœ°å€</label>
                <input
                  type="text"
                  id="host"
                  placeholder="localhost"
                  value="localhost"
                />
              </div>

              <div class="form-group">
                <label for="port">ç«¯å£</label>
                <input type="text" id="port" placeholder="3306" value="3306" />
              </div>

              <!-- Oracle è¿æ¥æ–¹å¼é€‰æ‹© -->
              <div
                class="form-group"
                id="oracleConnectionType"
                style="display: none"
              >
                <label for="connectionType">è¿æ¥æ–¹å¼</label>
                <select id="connectionType" onchange="onConnectionTypeChange()">
                  <option value="service">æœåŠ¡å (Service Name)</option>
                  <option value="sid">SID</option>
                  <option value="tns">TNSè¿æ¥ä¸²</option>
                </select>
              </div>

              <!-- MySQL æ•°æ®åº“å -->
              <div class="form-group" id="mysqlDatabase">
                <label for="database">æ•°æ®åº“å</label>
                <input type="text" id="database" placeholder="database_name" />
              </div>

              <!-- Oracle æœåŠ¡å/SID/TNS -->
              <div class="form-group" id="oracleService" style="display: none">
                <label for="serviceName">æœåŠ¡å</label>
                <input type="text" id="serviceName" placeholder="ORCL" />
              </div>

              <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" placeholder="root" />
              </div>

              <div class="form-group">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" placeholder="password" />
              </div>

              <!-- Oracle TNS è¿æ¥ä¸² -->
              <div
                class="form-group full-width"
                id="oracleTns"
                style="display: none"
              >
                <label for="tnsConnection">TNSè¿æ¥ä¸²</label>
                <textarea
                  id="tnsConnection"
                  placeholder="(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=ORCL)))"
                  rows="3"
                ></textarea>
              </div>

              <div class="form-group full-width">
                <label for="tableName">ç›®æ ‡è¡¨å</label>
                <input type="text" id="tableName" placeholder="users" />
              </div>

              <div class="form-group full-width">
                <label for="truncateCheckbox" style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0; padding: 8px 0;">
                  <input type="checkbox" id="truncateCheckbox" checked />
                  <span style="font-weight: normal; color: #374151; user-select: none;">å¯¼å…¥æ—¶æˆªæ–­å­—ç¬¦é•¿åº¦ï¼ˆé˜²æ­¢è¶…é•¿å­—æ®µï¼‰</span>
                </label>
              </div>
              
              <div class="form-group full-width">
                <label for="excelFile">é€‰æ‹©æ–‡ä»¶</label>
                <div class="file-input-wrapper">
                  <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ï¼Œä»…ä½œä¸ºæµè§ˆå™¨æ¨¡å¼çš„å¤‡ç”¨æ–¹æ¡ˆ -->
                  <input
                    type="file"
                    id="excelFile"
                    accept=".xlsx,.xls,.csv"
                    style="display: none"
                  />
                  <div class="file-input-display" onclick="selectExcelFile()">
                    é€‰æ‹©Excelæˆ–CSVæ–‡ä»¶
                    <span id="fileName" class="file-name"></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="button-group">
              <button class="btn-secondary" onclick="testConnection()">
                ğŸ” æµ‹è¯•è¿æ¥
              </button>
              <button class="btn-secondary" onclick="compareFields()">
                ğŸ“Š å­—æ®µå¯¹æ¯”
              </button>
              <button class="btn-secondary" onclick="saveConfig()">
                ğŸ’¾ ä¿å­˜é…ç½®
              </button>
              <button class="btn-primary" onclick="importExcel()">
                ğŸš€ å¼€å§‹å¯¼å…¥
              </button>
            </div>

            <div
              class="progress-container"
              id="progressContainer"
              style="display: none"
            >
              <div class="progress-text" id="progressText">å‡†å¤‡å¯¼å…¥...</div>
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="right-panel">
          <div class="logs-section">
            <div class="section-title">ğŸ“ æ“ä½œæ—¥å¿—</div>
            <div class="logs-container">
              <div class="logs-header">
                <div>
                  <span class="status-indicator status-ready"></span>
                  ç³»ç»ŸçŠ¶æ€
                </div>
                <div class="connection-status ready" id="connectionStatus">
                  <span class="status-indicator status-ready"></span>
                  åç«¯è¿æ¥æ­£å¸¸
                </div>
              </div>
              <div class="logs-content" id="logsContent">
                <div class="log-entry log-info">
                  [INFO] åº”ç”¨å·²å¯åŠ¨ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ...
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å­—æ®µå¯¹æ¯”æ¨¡æ€å¯¹è¯æ¡† -->
    <div id="fieldComparisonModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ğŸ“Š å­—æ®µå¯¹æ¯”ç»“æœ</h2>
          <button class="modal-close" onclick="closeFieldComparisonModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="comparison-summary" id="modalComparisonSummary"></div>
          <div class="comparison-modal-content">
            <div class="field-list">
              <h4>ğŸ“„ Excelå­—æ®µ</h4>
              <div id="modalExcelFields" class="field-items"></div>
            </div>
            <div class="field-list">
              <h4>ğŸ—„ï¸ æ•°æ®åº“å­—æ®µ</h4>
              <div id="modalDbFields" class="field-items"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/wails/ipc.js"></script>
    <script>
      let currentStatus = "ready";
      let backendConnected = false;

      function updateStatus(status) {
        currentStatus = status;
        const indicator = document.querySelector(".status-indicator");
        const header = document.querySelector(".logs-header");
        const statusText = header.querySelector("span:last-child");

        indicator.className = "status-indicator status-" + status;
      }

      function updateConnectionStatus(status, message) {
        const connectionStatus = document.getElementById("connectionStatus");
        connectionStatus.className = "connection-status " + status;
        connectionStatus.innerHTML = `
                <span class="status-indicator status-${status}"></span>
                ${message}
            `;
        backendConnected = status === "ready";
      }

      function addLog(message, type = "info") {
        const logsContent = document.getElementById("logsContent");
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry log-${type}`;
        logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
        logsContent.appendChild(logEntry);
        logsContent.scrollTop = logsContent.scrollHeight;
      }

      function updateProgress(percent, text) {
        const container = document.getElementById("progressContainer");
        const fill = document.getElementById("progressFill");
        const textEl = document.getElementById("progressText");

        container.style.display = "block";
        fill.style.width = percent + "%";
        textEl.textContent = text;
      }

      function resetProgress() {
        const container = document.getElementById("progressContainer");
        container.style.display = "none";
        document.getElementById("progressFill").style.width = "0%";
      }

      // æ•°æ®åº“ç±»å‹åˆ‡æ¢å¤„ç†
      function onDbTypeChange() {
        const dbType = document.getElementById("dbType").value;
        const portInput = document.getElementById("port");
        const mysqlDatabase = document.getElementById("mysqlDatabase");
        const oracleConnectionType = document.getElementById(
          "oracleConnectionType"
        );
        const oracleService = document.getElementById("oracleService");
        const oracleTns = document.getElementById("oracleTns");

        if (dbType === "mysql") {
          portInput.value = "3306";
          portInput.placeholder = "3306";
          mysqlDatabase.style.display = "block";
          oracleConnectionType.style.display = "none";
          oracleService.style.display = "none";
          oracleTns.style.display = "none";
          addLog("åˆ‡æ¢åˆ°MySQLæ•°æ®åº“é…ç½®", "info");
        } else if (dbType === "oracle") {
          portInput.value = "1521";
          portInput.placeholder = "1521";
          mysqlDatabase.style.display = "none";
          oracleConnectionType.style.display = "block";
          onConnectionTypeChange(); // é‡æ–°è®¾ç½®Oracleå­—æ®µ
          addLog("åˆ‡æ¢åˆ°Oracleæ•°æ®åº“é…ç½®", "info");
        }
      }

      // Oracleè¿æ¥æ–¹å¼åˆ‡æ¢å¤„ç†
      function onConnectionTypeChange() {
        const connectionType = document.getElementById("connectionType").value;
        const oracleService = document.getElementById("oracleService");
        const oracleTns = document.getElementById("oracleTns");

        if (connectionType === "service" || connectionType === "sid") {
          oracleService.style.display = "block";
          oracleTns.style.display = "none";
          const label = oracleService.querySelector("label");
          label.textContent = connectionType === "service" ? "æœåŠ¡å" : "SID";
          const input = oracleService.querySelector("input");
          input.placeholder = connectionType === "service" ? "ORCL" : "ORCL";
          input.id = connectionType === "service" ? "serviceName" : "sid";
        } else if (connectionType === "tns") {
          oracleService.style.display = "none";
          oracleTns.style.display = "block";
        }
      }

      // å½“å‰é€‰æ‹©çš„æ–‡ä»¶å®Œæ•´è·¯å¾„ï¼ˆä¾›åç«¯ä½¿ç”¨ï¼‰
      let currentFilePath = "";

      // ä½¿ç”¨ Wails åŸç”Ÿå¯¹è¯æ¡†é€‰æ‹©æ–‡ä»¶ï¼ˆæ¡Œé¢åº”ç”¨åœºæ™¯ï¼‰
      async function selectExcelFile() {
        // åœ¨çº¯æµè§ˆå™¨ä¸­æ²¡æœ‰ window.goï¼Œé€€å›åˆ°éšè—çš„ <input type="file">
        if (
          typeof window.go === "undefined" ||
          !window.go.main ||
          !window.go.main.App
        ) {
          const input = document.getElementById("excelFile");
          input.click();
          return;
        }

        try {
          const path = await window.go.main.App.SelectExcelFile();
          const fileNameEl = document.getElementById("fileName");
          const tableNameInput = document.getElementById("tableName");

          if (!path) {
            addLog("æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶", "warning");
            return;
          }

          currentFilePath = path;

          // æ˜¾ç¤ºå®Œæ•´è·¯å¾„
          fileNameEl.textContent = `(${path})`;

          // è‡ªåŠ¨è®¾ç½®è¡¨åï¼ˆå–æ–‡ä»¶åå»æ‰æ‰©å±•åï¼‰
          const justName = path.split(/[\\/]/).pop() || path;
          const fileNameWithoutExt = justName.replace(/\.[^/.]+$/, "");
          tableNameInput.value = fileNameWithoutExt.toLowerCase();
          addLog(`å·²é€‰æ‹©æ–‡ä»¶: ${path}`, "info");
        } catch (error) {
          console.error("é€‰æ‹©æ–‡ä»¶å¤±è´¥:", error);
          addLog("é€‰æ‹©æ–‡ä»¶å¤±è´¥: " + (error.message || error), "error");
        }
      }

      // æµè§ˆå™¨æ¨¡å¼é™çº§æ–¹æ¡ˆï¼šç›‘å¬éšè—çš„ <input type="file">
      document
        .getElementById("excelFile")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          const fileNameEl = document.getElementById("fileName");
          const tableNameInput = document.getElementById("tableName");

          if (file) {
            // æµè§ˆå™¨åªèƒ½æ‹¿åˆ°æ–‡ä»¶åï¼Œåç«¯æ— æ³•ç›´æ¥é€šè¿‡æµè§ˆå™¨è®¿é—®æœ¬åœ°æ–‡ä»¶
            const fullPath = file.name;
            currentFilePath = fullPath;

            fileNameEl.textContent = `(${fullPath})`;

            const fileNameWithoutExt = fullPath.replace(/\.[^/.]+$/, "");
            if (!tableNameInput.value) {
              tableNameInput.value = fileNameWithoutExt.toLowerCase();
              addLog(
                `å·²è‡ªåŠ¨è®¾ç½®è¡¨å: ${fileNameWithoutExt.toLowerCase()}`,
                "info"
              );
            }

            addLog(`å·²é€‰æ‹©æ–‡ä»¶(æµè§ˆå™¨æ¨¡å¼): ${fullPath}`, "info");
          } else {
            fileNameEl.textContent = "";
            currentFilePath = "";
          }
        });

      // æ£€æŸ¥åç«¯APIæ˜¯å¦å¯ç”¨ï¼ˆä½¿ç”¨ Wails ç”Ÿæˆçš„ window.go.main.Appï¼‰
      function isBackendReady() {
        const hasIPC = typeof window.go !== "undefined";
        const hasMain = window.go && window.go.main;
        const hasApp = hasMain && window.go.main.App;
        const ready = !!hasApp;

        console.log("Backend ready check:", {
          ready,
          hasIPC,
          hasMain,
          hasApp,
          go: window.go,
          timestamp: new Date().toISOString(),
        });

        return ready;
      }

      // ç­‰å¾…åç«¯è¿æ¥
      function waitForBackend(maxRetries = 30) {
        return new Promise((resolve, reject) => {
          let retries = 0;
          const checkBackend = () => {
            retries++;
            if (isBackendReady()) {
              console.log("Backend ready after", retries, "checks");
              resolve();
            } else if (retries >= maxRetries) {
              reject(new Error("åç«¯è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥Wailsåº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ"));
            } else {
              setTimeout(checkBackend, 100);
            }
          };
          checkBackend();
        });
      }

      // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
      window.addEventListener("load", function () {
        addLog("ç•Œé¢åˆå§‹åŒ–å®Œæˆ", "info");
        updateConnectionStatus("ready", "ç­‰å¾…æ“ä½œ");
        onDbTypeChange(); // åˆå§‹åŒ–æ•°æ®åº“ç±»å‹
      });

      async function testConnection() {
        const dbType = document.getElementById("dbType").value;
        const host = document.getElementById("host").value;
        const port = document.getElementById("port").value;
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        let connectionType = "";
        let serviceName = "";
        let tnsConnection = "";

        // éªŒè¯å¿…éœ€å­—æ®µ
        if (!username) {
          addLog("é”™è¯¯: è¯·å¡«å†™ç”¨æˆ·å", "error");
          return;
        }

        if (dbType === "mysql") {
          serviceName = document.getElementById("database").value;
          if (!serviceName) {
            addLog("é”™è¯¯: è¯·å¡«å†™æ•°æ®åº“å", "error");
            return;
          }
        } else if (dbType === "oracle") {
          connectionType = document.getElementById("connectionType").value;
          if (connectionType === "tns") {
            tnsConnection = document.getElementById("tnsConnection").value;
            if (!tnsConnection.trim()) {
              addLog("é”™è¯¯: è¯·å¡«å†™TNSè¿æ¥ä¸²", "error");
              return;
            }
          } else {
            serviceName =
              document.getElementById("serviceName")?.value ||
              document.getElementById("sid")?.value;
            if (!serviceName) {
              addLog(
                `é”™è¯¯: è¯·å¡«å†™${
                  connectionType === "service" ? "æœåŠ¡å" : "SID"
                }`,
                "error"
              );
              return;
            }
          }
        }

        updateStatus("busy");
        updateConnectionStatus("connecting", "è¿æ¥æ•°æ®åº“ä¸­...");
        addLog("æ­£åœ¨è¿æ¥åç«¯æœåŠ¡...", "info");

        try {
          // å…ˆç­‰å¾…åç«¯è¿æ¥
          await waitForBackend();

          // è°ƒç”¨åç«¯TestDatabaseConnectionæ–¹æ³•
          const result = await window.go.main.App.TestDatabaseConnection(
            dbType,
            host,
            port,
            username,
            password,
            connectionType,
            serviceName,
            tnsConnection
          );

          addLog("æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ!", "success");
          addLog(result, "info");
          updateConnectionStatus("ready", "æ•°æ®åº“è¿æ¥æˆåŠŸ");
          updateStatus("ready");
        } catch (error) {
          console.error("Test connection error:", error);
          const errorMsg = error.message || error.toString();
          if (
            errorMsg.includes("undefined is not an object") ||
            errorMsg.includes("backend.App")
          ) {
            addLog("åç«¯è¿æ¥å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", "error");
            updateConnectionStatus("error", "åç«¯è¿æ¥å¤±è´¥");
          } else {
            addLog(`æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ${errorMsg}`, "error");
            updateConnectionStatus("error", "æ•°æ®åº“è¿æ¥å¤±è´¥");
          }
          updateStatus("error");
          setTimeout(() => {
            updateStatus("ready");
            updateConnectionStatus("ready", "ç­‰å¾…æ“ä½œ");
          }, 3000);
        }
      }

      async function compareFields() {
        // æ£€æŸ¥åç«¯æ˜¯å¦å¯ç”¨
        if (!isBackendReady()) {
          addLog("é”™è¯¯: åç«¯è¿æ¥æœªå»ºç«‹ï¼Œè¯·ç¨åé‡è¯•", "error");
          return;
        }

        const dbType = document.getElementById("dbType").value;
        const host = document.getElementById("host").value;
        const port = document.getElementById("port").value;
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const tableName = document.getElementById("tableName").value;

        // è·å–è¿æ¥å‚æ•°
        let connectionType = "";
        let serviceName = "";
        let tnsConnection = "";

        if (dbType === "oracle") {
          connectionType = document.getElementById("connectionType").value;
          if (connectionType === "tns") {
            tnsConnection = document.getElementById("tnsConnection").value;
          } else {
            serviceName =
              document.getElementById("serviceName")?.value ||
              document.getElementById("sid")?.value ||
              "";
          }
        } else {
          serviceName = document.getElementById("database").value;
        }

        if (!tableName  || !currentFilePath) {
          addLog("é”™è¯¯: è¯·é€‰æ‹©æ–‡ä»¶å¹¶å¡«å†™è¡¨å", "error");
          return;
        }

        updateStatus("busy");
        updateConnectionStatus("connecting", "è¿æ¥åç«¯æœåŠ¡...");
        addLog("å¼€å§‹å­—æ®µå¯¹æ¯”...", "info");

        try {
          // å…ˆç­‰å¾…åç«¯è¿æ¥
          await waitForBackend();

          // è·å–Excelå­—æ®µï¼ˆä½¿ç”¨å®Œæ•´è·¯å¾„ï¼‰
          const excelHeaders = await window.go.main.App.GetExcelHeaders(
            currentFilePath
          );

          // è·å–æ•°æ®åº“å­—æ®µ
          const dbColumns = await window.go.main.App.GetTableColumns(
            dbType,
            host,
            port,
            username,
            password,
            tableName,
            connectionType,
            serviceName,
            tnsConnection
          );

          // å¯¹æ¯”å­—æ®µ
          const comparison = await window.go.main.App.CompareFields(
            excelHeaders,
            dbColumns
          );

          // æ˜¾ç¤ºå¯¹æ¯”ç»“æœå¯¹è¯æ¡†
          showFieldComparisonModal(comparison);

          addLog("å­—æ®µå¯¹æ¯”å®Œæˆ", "success");
          updateConnectionStatus("ready", "å¯¹æ¯”å®Œæˆ");
          updateStatus("ready");
        } catch (error) {
          console.error("Compare fields error:", error);
          const errorMsg = error.message || error.toString();
          if (
            errorMsg.includes("undefined is not an object") ||
            errorMsg.includes("backend.App")
          ) {
            addLog("åç«¯è¿æ¥å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", "error");
            updateConnectionStatus("error", "åç«¯è¿æ¥å¤±è´¥");
          } else {
            addLog(`å­—æ®µå¯¹æ¯”å¤±è´¥: ${errorMsg}`, "error");
            updateConnectionStatus("error", "å¯¹æ¯”å¤±è´¥");
          }
          updateStatus("error");
          setTimeout(() => {
            updateStatus("ready");
            updateConnectionStatus("ready", "ç­‰å¾…æ“ä½œ");
          }, 3000);
        }
      }

      function showFieldComparisonModal(comparison) {
        const modal = document.getElementById("fieldComparisonModal");
        const summary = document.getElementById("modalComparisonSummary");
        const excelFields = document.getElementById("modalExcelFields");
        const dbFields = document.getElementById("modalDbFields");

        // ç”Ÿæˆæ‘˜è¦ä¿¡æ¯
        const matched = comparison.matched || [];
        const missingInDb = comparison.missingInDb || [];
        const extraInExcel = comparison.extraInExcel || [];

        summary.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <div style="display: inline-block; margin-right: 20px;">âœ… åŒ¹é…å­—æ®µ: <span class="match-count">${matched.length}</span></div>
                    <div style="display: inline-block; margin-right: 20px;">âš ï¸ æ•°æ®åº“ç¼ºå¤±: <span class="mismatch-count">${missingInDb.length}</span></div>
                    <div style="display: inline-block;">âš ï¸ Excelå¤šä½™å­—æ®µ: <span class="mismatch-count">${extraInExcel.length}</span></div>
                </div>
            `;

        // æ˜¾ç¤ºExcelå­—æ®µ
        excelFields.innerHTML = "";
        const excelHeaders = comparison.excelHeaders || [];
        excelHeaders.forEach((header) => {
          const item = document.createElement("div");
          item.className = "field-item";

          const headerLower = header.toLowerCase().trim();
          const isMatched = matched.includes(headerLower);
          const isExtra = extraInExcel.includes(headerLower);

          if (isMatched) {
            item.classList.add("field-matched");
          } else if (isExtra) {
            item.classList.add("field-extra");
          } else {
            item.classList.add("field-normal");
          }

          item.textContent = header;
          excelFields.appendChild(item);
        });

        // æ˜¾ç¤ºæ•°æ®åº“å­—æ®µ
        dbFields.innerHTML = "";
        const dbColumns = comparison.dbColumns || [];
        dbColumns.forEach((column) => {
          const item = document.createElement("div");
          item.className = "field-item";

          const colLower = column.toLowerCase().trim();
          const isMatched = matched.includes(colLower);
          const isMissing = missingInDb.includes(colLower);

          if (isMatched) {
            item.classList.add("field-matched");
          } else if (isMissing) {
            item.classList.add("field-missing");
          } else {
            item.classList.add("field-normal");
          }

          item.textContent = column;
          dbFields.appendChild(item);
        });

        // æ˜¾ç¤ºæ¨¡æ€å¯¹è¯æ¡†
        modal.classList.add("show");
        addLog(
          `å¯¹æ¯”å®Œæˆ: ${matched.length}ä¸ªå­—æ®µåŒ¹é…, ${
            missingInDb.length + extraInExcel.length
          }ä¸ªå­—æ®µä¸åŒ¹é…`,
          "info"
        );
      }

      function closeFieldComparisonModal() {
        const modal = document.getElementById("fieldComparisonModal");
        modal.classList.remove("show");
      }

      // ç‚¹å‡»æ¨¡æ€å¯¹è¯æ¡†å¤–éƒ¨å…³é—­
      document
        .getElementById("fieldComparisonModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeFieldComparisonModal();
          }
        });

      // ESCé”®å…³é—­å¯¹è¯æ¡†
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeFieldComparisonModal();
        }
      });

      // ä¿å­˜é…ç½®åˆ°æœ¬åœ°ï¼ˆè°ƒç”¨åç«¯å†™å…¥æ–‡ä»¶ï¼‰
      async function saveConfig() {
        if (!window.go || !window.go.main || !window.go.main.App) {
          addLog("é”™è¯¯: åç«¯ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜é…ç½®", "error");
          return;
        }

        const cfg = {
          dbType: document.getElementById("dbType").value,
          host: document.getElementById("host").value,
          port: document.getElementById("port").value,
          database: document.getElementById("database").value,
          username: document.getElementById("username").value,
          password: document.getElementById("password").value,
          tableName: document.getElementById("tableName").value,
          connectionType: document.getElementById("connectionType")?.value || "",
          serviceName: document.getElementById("serviceName")?.value || "",
          tnsConnection: document.getElementById("tnsConnection")?.value || "",
          truncateChars: document.getElementById("truncateCheckbox")?.checked ? "true" : "false",
        };

        try {
          const msg = await window.go.main.App.SaveConfig(cfg);
          addLog(msg, "success");
        } catch (err) {
          console.error("ä¿å­˜é…ç½®å¤±è´¥:", err);
          addLog("ä¿å­˜é…ç½®å¤±è´¥: " + (err.message || err), "error");
        }
      }

      // è¯»å–é…ç½®å¹¶å¡«å……è¡¨å•
      async function loadConfig() {
        if (!window.go || !window.go.main || !window.go.main.App) {
          addLog("åç«¯æœªå°±ç»ªï¼Œæš‚ä¸åŠ è½½é…ç½®", "warning");
          return;
        }

        try {
          const cfg = await window.go.main.App.LoadConfig();
          if (!cfg) return;

          if (cfg.dbType) document.getElementById("dbType").value = cfg.dbType;
          if (cfg.host) document.getElementById("host").value = cfg.host;
          if (cfg.port) document.getElementById("port").value = cfg.port;
          if (cfg.database) document.getElementById("database").value = cfg.database;
          if (cfg.username) document.getElementById("username").value = cfg.username;
          if (cfg.password) document.getElementById("password").value = cfg.password;
          if (cfg.tableName) document.getElementById("tableName").value = cfg.tableName;

          // è¿æ¥æ–¹å¼ä¸ Oracle ç›¸å…³å­—æ®µ
          if (cfg.connectionType) {
            document.getElementById("connectionType").value = cfg.connectionType;
            onConnectionTypeChange();
          }
          if (cfg.serviceName && document.getElementById("serviceName"))
            document.getElementById("serviceName").value = cfg.serviceName;
          if (cfg.tnsConnection && document.getElementById("tnsConnection"))
            document.getElementById("tnsConnection").value = cfg.tnsConnection;

          // æˆªæ–­é€‰é¡¹
          if (cfg.truncateChars && document.getElementById("truncateCheckbox")) {
            document.getElementById("truncateCheckbox").checked = cfg.truncateChars === "true";
          }

          // æ ¹æ®æ•°æ®åº“ç±»å‹åˆ‡æ¢ UI
          onDbTypeChange();

          addLog("é…ç½®å·²åŠ è½½", "info");
        } catch (err) {
          console.error("åŠ è½½é…ç½®å¤±è´¥:", err);
          addLog("åŠ è½½é…ç½®å¤±è´¥: " + (err.message || err), "error");
        }
      }

      async function importExcel() {
        const dbType = document.getElementById("dbType").value;
        const host = document.getElementById("host").value;
        const port = document.getElementById("port").value;
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const tableName = document.getElementById("tableName").value;

        let connectionType = "";
        let serviceName = "";
        let tnsConnection = "";

        // éªŒè¯å¿…éœ€å­—æ®µ
        if (
          !username ||
          !tableName ||
          !currentFilePath
        ) {
          addLog("é”™è¯¯: è¯·å¡«å†™ç”¨æˆ·åã€è¡¨åå¹¶é€‰æ‹©æ–‡ä»¶", "error");
          return;
        }

        if (dbType === "mysql") {
          serviceName = document.getElementById("database").value;
          if (!serviceName) {
            addLog("é”™è¯¯: è¯·å¡«å†™æ•°æ®åº“å", "error");
            return;
          }
        } else if (dbType === "oracle") {
          connectionType = document.getElementById("connectionType").value;
          if (connectionType === "tns") {
            tnsConnection = document.getElementById("tnsConnection").value;
            if (!tnsConnection.trim()) {
              addLog("é”™è¯¯: è¯·å¡«å†™TNSè¿æ¥ä¸²", "error");
              return;
            }
          } else {
            serviceName =
              document.getElementById("serviceName")?.value ||
              document.getElementById("sid")?.value;
            if (!serviceName) {
              addLog(
                `é”™è¯¯: è¯·å¡«å†™${
                  connectionType === "service" ? "æœåŠ¡å" : "SID"
                }`,
                "error"
              );
              return;
            }
          }
        }

        // ç¦ç”¨å¯¼å…¥æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        const importButton = document.querySelector('button[onclick="importExcel()"]');
        if (importButton) {
          importButton.disabled = true;
          importButton.textContent = "ğŸš€ å¯¼å…¥ä¸­...";
        }

        updateStatus("busy");
        updateConnectionStatus("connecting", "è¿æ¥åç«¯æœåŠ¡...");
        addLog("æ­£åœ¨è¿æ¥åç«¯æœåŠ¡...", "info");

        try {
          // å…ˆç­‰å¾…åç«¯è¿æ¥
          await waitForBackend();

          // è·å–æˆªæ–­å­—ç¬¦é€‰é¡¹
          const truncateCheckbox = document.getElementById("truncateCheckbox");
          const shouldTruncate = truncateCheckbox.checked ? "true" : "false";

          // è°ƒç”¨åç«¯ImportExcelæ–¹æ³•ï¼ˆä¼ å…¥æ–‡ä»¶å®Œæ•´è·¯å¾„ï¼‰
          const result = await window.go.main.App.ImportExcel(
            dbType,
            host,
            port,
            username,
            password,
            tableName,
            currentFilePath,
            connectionType,
            serviceName,
            tnsConnection,
            shouldTruncate
          );

          addLog("å¯¼å…¥å®Œæˆ!", "success");
          addLog(result, "info");
          updateConnectionStatus("ready", "å¯¼å…¥å®Œæˆ");
          updateStatus("ready");
        } catch (error) {
          console.error("Import error:", error);
          const errorMsg = error.message || error.toString();
          if (
            errorMsg.includes("undefined is not an object") ||
            errorMsg.includes("backend.App")
          ) {
            addLog("åç«¯è¿æ¥å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", "error");
            updateConnectionStatus("error", "åç«¯è¿æ¥å¤±è´¥");
          } else {
            addLog(`å¯¼å…¥å¤±è´¥: ${errorMsg}`, "error");
            updateConnectionStatus("error", "å¯¼å…¥å¤±è´¥");
          }
          updateStatus("error");
          setTimeout(() => {
            updateStatus("ready");
            updateConnectionStatus("ready", "ç­‰å¾…æ“ä½œ");
          }, 3000);
        } finally {
          // æ¢å¤å¯¼å…¥æŒ‰é’®çŠ¶æ€
          if (importButton) {
            importButton.disabled = false;
            importButton.textContent = "ğŸš€ å¼€å§‹å¯¼å…¥";
          }
        }

        setTimeout(() => resetProgress(), 2000);
      }

      // é¡µé¢åŠ è½½å®Œæˆ
      window.addEventListener("load", function () {
        addLog("ç•Œé¢åˆå§‹åŒ–å®Œæˆ", "success");
        loadConfig();
      });

      // é”™è¯¯å¤„ç†
      window.addEventListener("error", function (e) {
        addLog(`JavaScripté”™è¯¯: ${e.message}`, "error");
      });

      // é”®ç›˜å¿«æ·é”®
      document.addEventListener("keydown", function (e) {
        if (e.ctrlKey || e.metaKey) {
          switch (e.key) {
            case "Enter":
              e.preventDefault();
              importExcel();
              break;
            case "t":
              e.preventDefault();
              testConnection();
              break;
          }
        }
      });
    </script>
  </body>
</html>
